<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABR ‚Äî Demand Pulse Radar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0a0c10;
            --card-bg: #12151a;
            --accent: #00c6ff;
            --accent-glow: rgba(0, 198, 255, 0.4 );
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.08);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: var(--bg); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            min-height: 100vh;
        }

        .header {
            padding: 1.5rem 2rem;
            background: rgba(10, 12, 16, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo { height: 40px; filter: drop-shadow(0 0 10px var(--accent-glow)); }

        .logout-btn {
            padding: 0.6rem 1.2rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .logout-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--text-dim); }

        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .chart-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            height: fit-content;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 2rem;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bulletin-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            position: sticky;
            top: 100px;
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }

        .bulletin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .bulletin-title { font-weight: 800; font-size: 1.2rem; line-height: 1.2; max-width: 180px; }

        .copy-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-btn:hover { background: var(--accent); color: var(--bg); }

        #bulletin-text {
            flex: 1;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-dim);
            padding-right: 10px;
        }

        #bulletin-text::-webkit-scrollbar { width: 4px; }
        #bulletin-text::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .bulletin-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .bulletin-h { color: var(--accent); font-weight: 700; margin-bottom: 0.5rem; font-size: 0.9rem; }

        .destinations-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 1rem;
        }

        .dest-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 1.8rem;
            border: 1px solid var(--border);
            transition: transform 0.3s, border-color 0.3s;
            position: relative;
            overflow: hidden;
        }

        .dest-card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .dest-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
        .dest-name { font-size: 1.4rem; font-weight: 800; line-height: 1.2; max-width: 200px; }

        .share-badge {
            background: rgba(255,255,255,0.05);
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            text-align: right;
        }
        .share-val { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); display: block; }
        .share-num { font-size: 1rem; font-weight: 800; color: var(--text-main); }

        .tactic-badges { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; min-height: 70px; align-content: flex-start; }
        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pill {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .metrics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .metric-box {
            background: rgba(255,255,255,0.03);
            padding: 1rem;
            border-radius: 16px;
            border: 1px solid var(--border);
        }
        .metric-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 0.5rem; display: block; }
        .metric-value { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }

        .origin-box {
            background: rgba(0, 198, 255, 0.05);
            padding: 1rem;
            border-radius: 16px;
            border: 1px solid rgba(0, 198, 255, 0.2);
            margin-bottom: 1.5rem;
        }
        .origin-text { font-size: 0.85rem; font-weight: 600; color: var(--accent); }

        .progress-container { margin-bottom: 1.5rem; }
        .progress-header { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-dim); }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 1s ease-out; }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        .weather-day { text-align: center; }
        .weather-temp { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.2rem; }
        .weather-label { font-size: 0.55rem; color: var(--text-dim); text-transform: uppercase; }

        @media (max-width: 1100px) {
            .main-container { grid-template-columns: 1fr; }
            .bulletin-card { position: static; height: auto; }
        }

        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .main-container { padding: 0 1rem; }
            .destinations-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="logo.png" alt="ABR Logo" class="logo">
        <a href="index.html" class="logout-btn">Sair do Sistema</a>
    </header>

    <main class="main-container">
        <section class="chart-section">
            <div class="section-title">
                TEND√äNCIA DE DEMANDA CONSOLIDADA (60 DIAS)
                <div style="font-size: 0.7rem; color: var(--text-dim); display: flex; align-items: center; gap: 10px;">
                    <span style="width: 12px; height: 12px; background: var(--accent); border-radius: 3px;"></span> Volume de Buscas
                </div>
            </div>
            <canvas id="mainChart" style="width: 100%; height: 350px;"></canvas>
        </section>

        <aside class="bulletin-card">
            <div class="bulletin-header">
                <div class="bulletin-title">BOLETIM ESTRAT√âGICO ABR</div>
                <button class="copy-btn" onclick="copyBulletin()">COPIAR BOLETIM</button>
            </div>
            <div id="bulletin-text">Carregando intelig√™ncia de mercado...</div>
        </aside>

        <div class="destinations-grid" id="destinations-container">
            <!-- Cards ser√£o inseridos via JS -->
        </div>
    </main>

    <script>
        let pulseData = null;

        async function init() {
            try {
                // TENTATIVA 1: SUPABASE
                const response = await fetch(
                    'https://torogxfslkqwgzkclhay.supabase.co/rest/v1/rpc/api_demand_pulse_latest',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvcm9neGZzbGtxd3F6a2NsaGF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTA2NDAsImV4cCI6MjA4MzAyNjY0MH0.uzl18r5B8vZGA0X90E8mRo9ZgH0-4aZwDQc5mH3p94A'
                        }
                    }
                 );

                const data = await response.json();

                if (!data || Object.keys(data).length === 0) {
                    throw new Error("Supabase retornou JSON vazio");
                }

                pulseData = data;
                renderDashboard();

            } catch (err) {
                console.warn("Falha Supabase ‚Äî fallback para pulse-data.json", err);
                
                // TENTATIVA 2: FALLBACK LOCAL
                try {
                    const fallback = await fetch('pulse-data.json');
                    pulseData = await fallback.json();
                    renderDashboard();
                } catch (fatal) {
                    document.getElementById('bulletin-text').innerHTML = 
                        '<span style="color: var(--danger)">Erro cr√≠tico: N√£o foi poss√≠vel carregar dados do banco ou do arquivo local.</span>';
                }
            }
        }

        function renderDashboard() {
            renderChart();
            renderCards();
            renderBulletin();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: pulseData.chartData.labels,
                    datasets: [{
                        label: 'Volume de Buscas',
                        data: pulseData.chartData.values,
                        borderColor: '#00c6ff',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: ctx.createLinearGradient(0, 0, 0, 400),
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        function renderCards() {
            const container = document.getElementById('destinations-container');
            container.innerHTML = pulseData.destinations.map(dest => `
                <div class="dest-card">
                    <div class="dest-header">
                        <div class="dest-name">${dest.name}</div>
                        <div class="share-badge">
                            <span class="share-val">SHARE</span>
                            <span class="share-num">${dest.marketShare}%</span>
                        </div>
                    </div>

                    <div class="tactic-badges">
                        ${dest.badges.map(b => `
                            <span class="badge" style="background: ${b.color}20; color: ${b.color}; border: 1px solid ${b.color}40">
                                ${b.text}
                            </span>
                        `).join('')}
                    </div>

                    <div class="status-pill" style="background: ${dest.growth.startsWith('+') ? 'var(--success)' : 'var(--warning)'}20; color: ${dest.growth.startsWith('+') ? 'var(--success)' : 'var(--warning)'}">
                        ${dest.status.toUpperCase()}
                    </div>

                    <div class="metrics-row">
                        <div class="metric-box">
                            <span class="metric-label">Humor do Mercado</span>
                            <div class="metric-value">
                                ${dest.sentiment === 'Positivo' ? 'üòä' : (dest.sentiment === 'Neutro' ? 'üòê' : 'üòü')}
                                ${dest.sentiment}
                            </div>
                        </div>
                        <div class="metric-box">
                            <span class="metric-label">Press√£o de Reserva</span>
                            <div class="metric-value">üö® ${dest.bookingPressure}%</div>
                        </div>
                    </div>

                    <div class="origin-box">
                        <div class="origin-text">üìç Origem Dominante: ${dest.topOrigin} (${dest.originPower}%)</div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-header">
                            <span>PERFIL DE P√öBLICO</span>
                            <span>üë• ${dest.loyalty}% ‚úàÔ∏è ${100-dest.loyalty}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${dest.loyalty}%"></div>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-header">
                            <span>INTEN√á√ÉO DE ESTADIA</span>
                            <span>üåô ${dest.overnight}% ‚òÄÔ∏è ${dest.daytrip}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${dest.overnight}%; background: #00c6ff"></div>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-header">
                            <span>IMPACTO CLIM√ÅTICO (IEC)</span>
                            <span style="color: var(--success)">‚ö° Alavancagem Alta</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${dest.iecValue}%; background: var(--success)"></div>
                        </div>
                    </div>

                    <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid var(--border);">
                        <div style="color: var(--accent); font-size: 0.7rem; font-weight: 800; margin-bottom: 0.4rem;">üí° INSIGHT ESTRAT√âGICO</div>
                        <div style="font-size: 0.8rem; line-height: 1.4; color: var(--text-dim);">${dest.insight}</div>
                    </div>

                    <div class="weather-grid">
                        ${dest.weather.map(w => `
                            <div class="weather-day">
                                <div class="weather-temp">${w.temp}¬∞</div>
                                <div class="weather-label">${w.cond}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderBulletin() {
            const container = document.getElementById('bulletin-text');
            let html = `
                <div class="bulletin-section">
                    <div class="bulletin-h">üèÜ MARKET SHARE & DOMIN√ÇNCIA</div>
                    ${pulseData.destinations.map(d => `‚Ä¢ ${d.name}: ${d.marketShare}% ${d.shareTrend === 'up' ? '‚ñ≤' : '‚ñº'}`).join('  
')}
                </div>
            `;

            pulseData.destinations.slice(0, 4).forEach(d => {
                html += `
                    <div class="bulletin-section">
                        <div class="bulletin-h">üìç ${d.name.toUpperCase()}</div>
                        ‚Ä¢ Status: ${d.status} (${d.growth} var)  

                        ‚Ä¢ Sentimento: ${d.sentiment} (${d.insight})  

                        ‚Ä¢ Press√£o de Reserva: ${d.bookingPressure}%  

                        ‚Ä¢ Gatilho de Proximidade: ${d.originPower}% (${d.topOrigin})  

                        ‚Ä¢ Alerta T√°tico: Oportunidade de convers√£o imediata via IEC.
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function copyBulletin() {
            const text = document.getElementById('bulletin-text').innerText;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('.copy-btn');
            btn.innerText = 'COPIADO!';
            setTimeout(() => btn.innerText = 'COPIAR BOLETIM', 2000);
        }

        init();
    </script>
</body>
</html>
