<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEMAND PULSE — ABR ALL-IN-ONE</title>

<!-- FONTS -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<!-- ===================== STYLE ===================== -->
<style>
:root{
  --accent:#00c6ff;
  --green:#39ff14;
  --red:#ff3131;
  --yellow:#ffea00;
  --bg:#000;
  --panel:rgba(15,18,22,.88);
  --border:rgba(255,255,255,.08);
  --text:#eaf3ff;
  --dim:#9ca3af;
  --shadow:0 14px 40px rgba(0,0,0,.85);
}

*{
  box-sizing:border-box;
  user-select:none;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Poppins,sans-serif;
  min-height:100vh;
  overflow-x:hidden;
}

.container{
  max-width:1400px;
  margin:auto;
  padding:20px;
  position:relative;
  z-index:1;
}

h1{
  text-align:center;
  color:var(--accent);
  margin:10px 0 30px;
  font-weight:800;
  letter-spacing:2px;
}

.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:24px;
  padding:24px;
  margin-bottom:30px;
  box-shadow:var(--shadow);
}

.grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:30px;
}

#cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
  gap:24px;
}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:24px;
  padding:20px;
  box-shadow:var(--shadow);
}

.badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:18px;
  font-size:.65rem;
  font-weight:800;
  margin-bottom:8px;
  text-transform:uppercase;
}

.up{background:rgba(57,255,20,.15);color:var(--green);border:1px solid var(--green)}
.down{background:rgba(255,49,49,.15);color:var(--red);border:1px solid var(--red)}
.stable{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.3)}

.metric{
  font-size:.75rem;
  color:var(--dim);
  margin:4px 0;
}

.origin{
  color:var(--yellow);
  font-size:.75rem;
  font-weight:700;
}

canvas{
  width:100%!important;
  height:320px!important;
}

#boletim{
  white-space:pre-wrap;
  font-family:"Fira Code",monospace;
  font-size:.72rem;
  color:var(--dim);
  line-height:1.55;
}

@media(max-width:1024px){
  .grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <div class="container">
    <h1>DEMAND PULSE — ABR ALL-IN-ONE</h1>

    <!-- PAINEL BI / TIMELINE -->
    <div class="panel">
      <canvas id="timeline"></canvas>
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="grid">
      
      <!-- CARDS DOS DESTINOS -->
      <div id="cards">
        <!-- cards renderizados via JS -->
      </div>

      <!-- BOLETIM ESTRATÉGICO -->
      <div class="panel">
        <h3>Boletim Estratégico</h3>
        <div id="boletim">Carregando dados…</div>
      </div>

    </div>
  </div>
<script>
/* ===================== CONFIGURAÇÃO SUPABASE ===================== */
const SUPABASE_URL = "https://torogxfslkqwqzkclhay.supabase.co";
const SUPABASE_ANON_KEY = "SUA_ANON_KEY_AQUI";
const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ===================== HELPERS SEGUROS ===================== */
function num(v, d = 0) {
  return Number.isFinite(v) ? v : d;
}
function arr(v) {
  return Array.isArray(v) ? v : [];
}
function txt(v) {
  return String(v ?? "N/A");
}

/* ===================== ESTADO GLOBAL ===================== */
let snapshots = [];
let dataMap = {};
let chart = null;

/* ===================== LOAD INICIAL ===================== */
window.onload = loadData;

async function loadData() {
  const { data, error } = await supabase
    .from("demand_pulse_snapshots")
    .select("payload,captured_at")
    .order("captured_at", { ascending: true })
    .limit(180);

  if (error || !data || !data.length) {
    document.getElementById("boletim").innerText =
      "⚠️ Falha ao carregar dados do Supabase.";
    return;
  }

  snapshots = data;
  dataMap = transformPayload(data[data.length - 1].payload);
  renderAll();
}

/* ===================== TRANSFORMAÇÃO DE PAYLOAD ===================== */
function transformPayload(payload) {
  const out = {};

  if (!payload || !Array.isArray(payload.destinations)) return out;

  payload.destinations.forEach((d) => {
    if (!d || !d.id) return;

    out[d.id] = {
      id: d.id,
      name: txt(d.name),
      timeline: arr(d.timeline).length >= 2 ? d.timeline : [0, 0],
      recentChange: num(d.recentChange),
      sentiment: num(d.sentiment, 0.8),
      bookingPressure: num(d.bookingPressure, 0.7),
      proximityTrigger: num(d.proximityTrigger, 0.6),
      socialBuzz: num(d.socialBuzz, 0.5),
      stayIntent: num(d.stayIntent, 0.7),
      elasticityIndex: num(d.elasticityIndex, 0),
      perfil_publico: txt(d.perfil_publico),
      insight: txt(d.insight),
      topOrigins: arr(d.topOrigins),
      origem_dominante: txt(d.topOrigins?.[0]?.location)
    };
  });

  out.__top3 = arr(payload.top_3_ranking);
  return out;
}

/* ===================== RENDER GERAL ===================== */
function renderAll() {
  renderChart();
  renderCards();
  renderBoletim();
}
</script>
</script>
</body>
</html>
