<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DEMAND PULSE ‚Äî ABR ALL IN ONE</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000000;
      --panel: rgba(15, 18, 22, 0.62);
      --panel-2: rgba(15, 18, 22, 0.48);
      --line: rgba(255,255,255,0.10);
      --text:#eaf3ff;
      --muted: rgba(234,243,255,0.70);
      --accent:#00c6ff;
      --shadow: 0 18px 50px rgba(0,0,0,0.55);
      --radius: 18px;

      --ok: rgba(126,231,135,.95);
      --flat: rgba(255,204,102,.95);
      --bad: rgba(255,107,107,.95);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #matrix{
      position: fixed;
      inset: 0;
      z-index: 0;
      display:block;
      background: #000;
    }

    /* TELA DE LOGIN ORIGINAL RESTAURADA COM RIGOR ABSOLUTO */
    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .login-box {
      background: var(--panel);
      padding: 40px;
      border-radius: 24px;
      border: 1px solid var(--accent);
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 40px rgba(0, 198, 255, 0.25);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
    }
    .login-box h2 {
      color: var(--accent);
      font-size: 1.2rem;
      font-weight: 800;
      margin-bottom: 20px;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .input-group {
      position: relative;
      margin: 20px 0;
      display: flex;
      align-items: center;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--line);
      border-radius: 12px;
    }
    .login-box input {
      flex: 1;
      padding: 15px;
      background: transparent;
      border: none;
      color: white;
      text-align: center;
      font-size: 1.1rem;
      outline: none;
    }
    .toggle-pass {
      padding: 0 15px;
      cursor: pointer;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      user-select: none;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .login-box button {
      width: 100%;
      padding: 15px;
      background: var(--accent);
      color: #001018;
      border: none;
      border-radius: 12px;
      font-weight: 800;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.3s;
      margin-bottom: 10px;
    }
    .login-box button:hover {
      transform: scale(1.02);
      box-shadow: 0 0 20px rgba(0, 198, 255, 0.4);
    }
    .btn-back-hub {
      display: block;
      color: var(--muted);
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      margin-top: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: 0.3s;
      cursor: pointer;
      background: none;
      border: none;
      width: 100%;
      text-align: center;
    }
    .btn-back-hub:hover { color: var(--accent); }

    .wrap{
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display:none;
      flex-direction:column;
    }

    header{
      max-width: 1100px;
      margin: 0 auto;
      padding: 26px 16px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      width: 100%;
    }
    .logo{
      width:230px;
      height:auto;
      display:block;
      filter: drop-shadow(0 12px 25px rgba(0,198,255,0.15));
      user-select:none;
      -webkit-user-drag:none;
    }
    .btn-exit {
      background: rgba(255, 59, 48, 0.15);
      color: #ff3b30;
      border: 1px solid #ff3b30;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-decoration: none;
      transition: 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .btn-exit:hover {
      background: #ff3b30;
      color: white;
    }

    .pitch{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 14px;
      text-align:center;
    }
    .pitch h1{margin: 6px 0 6px; font-size: 20px; letter-spacing: 0.4px; font-weight: 800;}
    .pitch p{margin: 0 auto; max-width: 860px; color: var(--muted); font-size: 13px; line-height: 1.35;}

    .tag{
      display:inline-flex; gap:8px; align-items:center;
      margin-top: 10px; padding: 8px 12px;
      border-radius: 999px; border: 1px solid var(--line);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      font-size: 12px; color: var(--muted); box-shadow: var(--shadow);
    }
    .tag .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(0,198,255,0.55);
    }

    .statusbar{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 10px;
      width: 100%;
    }
    .status{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,0.28);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 12px;
      color: var(--muted);
      font-size: 12px;
      box-shadow: var(--shadow);
      text-align:center;
    }

    .input-box{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 18px;
    }
    .input-card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 14px;
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:center;
    }
    select, button{
      font-family: inherit;
      border-radius: 14px;
      border: 1px solid var(--line);
      padding: 12px 14px;
      font-size: 13px;
      outline: none;
      background: rgba(0,0,0,0.35);
      color: var(--text);
      min-height: 44px;
    }
    select{min-width: 230px;}
    button{
      border: none; cursor: pointer; font-weight: 800;
      color: #001018;
      background: linear-gradient(135deg, rgba(0,198,255,.98), rgba(0,198,255,.55));
      box-shadow: 0 10px 25px rgba(0,198,255,0.16);
      min-width: 210px;
    }
    button:active{transform: translateY(1px);}
    .mini-btn{
      min-width: 180px; font-weight: 700;
      color: var(--muted);
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--line);
      box-shadow: none;
    }

    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 20px;
      width: 100%;
      flex: 1;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      select{min-width: 100%;}
      button{min-width: 100%;}
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .card .head{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card h2{margin:0; font-size: 14px; font-weight: 800; letter-spacing: .25px;}
    .sub{margin-top: 6px; color: var(--muted); font-size: 12px; line-height: 1.35; max-width: 760px;}
    .card .body{padding: 14px;}

    .dest-list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 640px){
      .dest-list{grid-template-columns: 1fr;}
    }

    .dest{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--panel-2);
      padding: 12px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .name{font-weight: 800; font-size: 13px; letter-spacing: .2px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,0.28);
      color: var(--muted);
      white-space:nowrap;
    }
    .state{border:none; color:#001018; font-weight: 900; letter-spacing: .3px;}
    .up{background: var(--ok);}
    .flat{background: var(--flat);}
    .down{background: var(--bad);}

    .metric{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      padding: 10px;
    }
    .kpi .label{color: var(--muted); font-size: 11px; margin-bottom: 4px;}
    .kpi .value{font-size: 16px; font-weight: 900;}
    .kpi .hint{margin-top: 4px; color: var(--muted); font-size: 11px; line-height: 1.25;}

    .divider{height:1px;background: var(--line); margin: 10px 0;}
    .note{color: var(--muted); font-size: 12px; line-height: 1.45;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    footer{
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px 24px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
      text-align:center;
    }

    /* TICKER CSS */
    .ticker-wrap {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      overflow: hidden;
      height: 28px;
      background-color: rgba(0, 0, 0, 0.85);
      border-bottom: 1px solid var(--line);
      z-index: 1000;
      display: flex;
      align-items: center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .ticker {
      display: inline-block;
      white-space: nowrap;
      padding-right: 100%;
      animation: ticker 40s linear infinite;
      font-family: ui-monospace, monospace;
      font-size: 11px;
      color: var(--accent);
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .ticker span { margin-right: 40px; display: inline-block; }
    .ticker b { color: var(--ok); }
    @keyframes ticker {
      0% { transform: translate3d(0, 0, 0); }
      100% { transform: translate3d(-100%, 0, 0); }
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <canvas id="matrix"></canvas>

  <!-- TELA DE LOGIN ORIGINAL RESTAURADA COM RIGOR ABSOLUTO -->
  <div id="login-overlay">
    <img src="logo.png" alt="ABR" style="max-width: 200px; margin-bottom: 30px; filter: drop-shadow(0 0 20px rgba(0,198,255,0.4));">
    <div class="login-box">
      <h2>ACESSO RESTRITO</h2>
      <div class="input-group">
        <input type="password" id="password-input" placeholder="Digite sua senha">
        <span class="toggle-pass" onclick="togglePassword()">VER</span>
      </div>
      <button onclick="checkLogin()">Entrar no Radar</button>
      <!-- BOT√ÉO HUB NA √ÅREA DE LOGIN CORRIGIDO -->
      <a href="hub_index.html" class="btn-back-hub">Voltar ao HUB</a>
      <p id="login-error" style="color: #ff3b30; font-size: 0.8rem; margin-top: 15px; display: none; font-weight: 600;">Senha incorreta.</p>
    </div>
  </div>

  <div class="wrap" id="main-content">
    <div class="ticker-wrap">
      <div class="ticker" id="ticker">
        CARREGANDO PULSO DE MERCADO... üì° SINCRONIZANDO COM SUPABASE... üü¢ STATUS: LIVE
      </div>
    </div>

    <header style="margin-top: 28px;">
      <img class="logo" src="logo.png" alt="ABR ALL IN ONE" />
      <!-- BOT√ÉO HUB NA √ÅREA DO RADAR CORRIGIDO -->
      <div style="display: flex; gap: 10px;">
        <a href="hub_index.html" class="btn-exit" style="background: rgba(0, 198, 255, 0.1); color: var(--accent); border-color: var(--accent);">‚Üê HUB</a>
        <a href="#" class="btn-exit" id="btnExit">‚Üê SAIR</a>
      </div>
    </header>

    <section class="pitch">
      <h1>DEMAND PULSE ‚Äî Radar Direcional do Destino</h1>
      <p>
        Intelig√™ncia de demanda em tempo real. An√°lise cont√≠nua de milh√µes de sinais digitais transformados em pulso de mercado.
      </p>
      <p style="margin-top: 10px;">
        Leitura direcional do pulso de demanda do destino (üî∫ aquecendo, ‚ûñ est√°vel, üîª arrefecendo),
        baseada em varia√ß√£o e persist√™ncia ‚Äî <strong>sem promessa de volume absoluto</strong>.
        Monte Verde √© o destino √¢ncora.
      </p>
      <div class="tag"><span class="dot"></span></div>
    </section>

    <div class="statusbar">
      <div class="status" id="status"></div>
    </div>

    <section class="input-box">
      <div class="input-card">
        <div class="controls">
          <select id="d1" disabled style="background:rgba(0,198,255,0.1); border-color:var(--accent); color:var(--accent); font-weight:800;"></select>
          <select id="d2"></select>
          <select id="d3"></select>
          <select id="d4"></select>
          <button id="btnRun">Atualizar Pulso</button>
        </div>
        <div style="margin-top:10px" class="note">
          Este HTML l√™ os dados de <span class="mono">pulse-data.json</span> na mesma pasta (Netlify/UOL Host funciona).
        </div>
      </div>
    </section>

    <main>
      <div class="grid">
        <section class="card">
          <div class="head">
            <div>
              <h2>Comparativo (at√© 4 destinos)</h2>
              <div class="sub">
                Estados üî∫‚ûñüîª calculados pelos campos: <span class="mono">recentChange</span> e <span class="mono">persistence</span>.
              </div>
            </div>
          </div>
          <div class="body">
            <div class="dest-list" id="destList"></div>
            <div class="divider"></div>
            <div class="note">Voc√™ pode atualizar o <span class="mono">pulse-data.json</span> e clicar em ‚ÄúAtualizar Pulso‚Äù.</div>
          </div>
        </section>

        <aside class="card">
          <div class="head">
            <div>
              <h2>Boletim institucional (1 p√°gina)</h2>
              <div class="sub">Texto objetivo para entidade/associa√ß√£o.</div>
            </div>
            <button class="mini-btn" id="btnCopy">Copiar boletim</button>
          </div>
          <div class="body">
            <div id="bulletin"></div>
            <div class="divider"></div>
            <div class="note">Observa√ß√£o: este MVP n√£o prev√™ reservas. Entrega contexto direcional.</div>
          </div>
        </aside>
      </div>
    </main>

    <footer>
      ¬© 2026 ABR ‚Äî Demand Pulse Radar. Todos os direitos reservados.
    </footer>
  </div>

  <script>
    // L√ìGICA DE LOGIN DEFINITIVA E RIGOROSA
    const AUTH_KEY = "demand_pulse_auth";
    
    function togglePassword() {
      const input = document.getElementById('password-input');
      const btn = document.querySelector('.toggle-pass');
      if (input.type === "password") {
        input.type = "text";
        btn.textContent = "OCULTAR";
      } else {
        input.type = "password";
        btn.textContent = "VER";
      }
    }

    function checkLogin() {
      const input = document.getElementById('password-input').value.trim();
      // SENHAS OFICIAIS: abrturbo e testecliente
      if (input === "abrturbo" || input === "testecliente" || input === "ABRTURBO" || input === "TESTECLIENTE") {
        localStorage.setItem(AUTH_KEY, "true");
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.display = 'flex';
        boot();
      } else {
        document.getElementById('login-error').style.display = 'block';
      }
    }

    function checkAuth() {
      const auth = localStorage.getItem(AUTH_KEY);
      if (auth === "true") {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('main-content').style.display = 'flex';
        return true;
      }
      return false;
    }

    document.getElementById('btnExit').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem(AUTH_KEY);
      window.location.reload();
    });

    const DESTINATIONS = [
      { id: "monte_verde_mg", label: "Monte Verde (MG) ‚Äî √Çncora" },
      { id: "campos_do_jordao_sp", label: "Campos do Jord√£o (SP)" },
      { id: "gramado_canela_rs", label: "Gramado + Canela (RS)" },
      { id: "goncalves_mg", label: "Gon√ßalves (MG)" },
      { id: "santo_antonio_do_pinhal_sp", label: "S. A. do Pinhal (SP)" },
      { id: "serra_negra_sp", label: "Serra Negra (SP)" },
      { id: "pocos_de_caldas_mg", label: "Po√ßos de Caldas (MG)" },
      { id: "sao_lourenco_mg", label: "S√£o Louren√ßo (MG)" }
    ];

    const els = {
      d1: document.getElementById("d1"),
      d2: document.getElementById("d2"),
      d3: document.getElementById("d3"),
      d4: document.getElementById("d4"),
      btnRun: document.getElementById("btnRun"),
      destList: document.getElementById("destList"),
      bulletin: document.getElementById("bulletin"),
      btnCopy: document.getElementById("btnCopy"),
      status: document.getElementById("status"),
      ticker: document.getElementById("ticker")
    };

    let PULSE_DATA = null;

    function setStatus(msg){ els.status.textContent = msg; }

    function fillSelect(selectEl, defaultId) {
      selectEl.innerHTML = "";
      for (const d of DESTINATIONS) {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.label;
        selectEl.appendChild(opt);
      }
      selectEl.value = defaultId || DESTINATIONS[0].id;
    }

    function safeNumber(x, fallback=0){
      const n = Number(x);
      return Number.isFinite(n) ? n : fallback;
    }

    function fmtPct(x) {
      const num = Number(x);
      if (!Number.isFinite(num)) return "0,0%";
      const v = Math.round(num * 1000) / 10;
      return (v > 0 ? "+" : "") + v.toFixed(1).replace(".", ",") + "%";
    }

    function classifyFromData(rec){
      const rc = safeNumber(rec?.recentChange, 0);
      const ps = safeNumber(rec?.persistence, 0);
      if (ps < 0.55) return { label: "‚ûñ Est√°vel", cls: "flat" };
      if (rc >= 0.12) return { label: "üî∫ Aquecendo", cls: "up" };
      if (rc <= -0.10) return { label: "üîª Arrefecendo", cls: "down" };
      return { label: "‚ûñ Est√°vel", cls: "flat" };
    }

    function renderDestCard(d, rec) {
      const pulse = classifyFromData(rec);
      const rc = safeNumber(rec?.recentChange, 0);
      const ps = safeNumber(rec?.persistence, 0);
      const note = (rec?.note && String(rec.note).trim()) ? String(rec.note) : "Sem observa√ß√£o.";
      const isAnchor = d.id === 'monte_verde_mg';

      const wrap = document.createElement("div");
      wrap.className = "dest";
      if (isAnchor) {
        wrap.style.border = "1px solid var(--accent)";
        wrap.style.background = "rgba(0,198,255,0.05)";
      }

      wrap.innerHTML = `
        <div class="row">
          <div class="name">${d.label} ${isAnchor ? '‚≠ê' : ''}</div>
          <div class="pill state ${pulse.cls}">${pulse.label}</div>
        </div>
        <div class="metric">
          <div class="kpi">
            <div class="label">Varia√ß√£o recente (vs padr√£o)</div>
            <div class="value">${fmtPct(rc)}</div>
            <div class="hint">Campo do JSON: <span class="mono">recentChange</span></div>
          </div>
          <div class="kpi">
            <div class="label">Persist√™ncia do movimento</div>
            <div class="value">${Math.round(ps * 100)}%</div>
            <div class="hint">${note}</div>
          </div>
        </div>
      `;
      return wrap;
    }

    function buildBulletin(results) {
      const now = new Date();
      const dt = now.toLocaleDateString("pt-BR", { year:"numeric", month:"long", day:"2-digit" });
      const mv = results.find(r => r.id === 'monte_verde_mg');

      const lines = results.map(r => {
        let insight = "";
        if (mv && r.id !== 'monte_verde_mg') {
          const diff = (mv.recentChange - r.recentChange) * 100;
          insight = ` | Performance vs MV: ${diff > 0 ? '+' : ''}${diff.toFixed(1)}%`;
        }
        return `‚Ä¢ ${r.label}: ${r.pulseLabel} (varia√ß√£o ${fmtPct(r.recentChange)} | persist√™ncia ${Math.round(r.persistence*100)}%${insight}).`;
      }).join("<br/>");

      return `
        <div style="font-weight:900;font-size:14px;margin-bottom:8px;">
          Boletim DEMAND PULSE ‚Äî Destinos monitorados (${dt})
        </div>
        <div style="color:var(--muted);font-size:12px;line-height:1.45;">
          Leitura direcional do pulso de demanda do destino, baseada em varia√ß√£o vs. padr√£o hist√≥rico e persist√™ncia do movimento.
          Monte Verde √© o destino √¢ncora do radar.
        </div>
        <div class="divider"></div>
        <div style="font-size:13px;line-height:1.55;">${lines}</div>
        <div class="divider"></div>
        <div style="color:var(--muted);font-size:12px;line-height:1.45;">
          Interpreta√ß√£o: ‚Äúüî∫ aquecendo‚Äù sugere maior press√£o relativa; ‚Äúüîª arrefecendo‚Äù sugere redu√ß√£o; ‚Äú‚ûñ est√°vel‚Äù indica manuten√ß√£o.
        </div>
      `;
    }

    function updateTicker(data) {
      if (!data || !data.monte_verde_mg) return;
      const mv = data.monte_verde_mg;
      const rc = fmtPct(mv.recentChange);
      const ps = Math.round(mv.persistence * 100);
      const content = `
        <span>MONTE VERDE √ÇNCORA: <b>VARIA√á√ÉO ${rc}</b></span>
        <span>PERSIST√äNCIA: <b>${ps}%</b></span>
        <span>STATUS: <b>LIVE üü¢</b></span>
        <span>ROAD PRESSURE: <b>AGUARDANDO API...</b></span>
        <span>RATE INDEX: <b>AGUARDANDO SHOPPING...</b></span>
      `;
      els.ticker.innerHTML = content + content + content;
    }

    async function loadPulseData(){
      try{
        const url = "pulse-data.json?_=" + Date.now();
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const json = await res.json();
        PULSE_DATA = json;
        setStatus("");
        updateTicker(json);
        return true;
      }catch(err){
        PULSE_DATA = null;
        setStatus("Erro ao ler dados: " + err.message);
        return false;
      }
    }

    function run(){
      els.destList.innerHTML = "";
      const selectedIds = [els.d1.value, els.d2.value, els.d3.value, els.d4.value].filter(Boolean);
      const results = [];
      for(const id of selectedIds){
        const d = DESTINATIONS.find(dest => dest.id === id);
        if(!d) continue;
        const rec = (PULSE_DATA && PULSE_DATA[d.id]) ? PULSE_DATA[d.id] : { recentChange: 0, persistence: 0, note: "chave ausente no JSON" };
        const pulse = classifyFromData(rec);
        els.destList.appendChild(renderDestCard(d, rec));
        results.push({
          id: d.id,
          label: d.label,
          pulseLabel: pulse.label,
          recentChange: safeNumber(rec.recentChange, 0),
          persistence: safeNumber(rec.persistence, 0)
        });
      }
      els.bulletin.innerHTML = buildBulletin(results);
    }

    async function boot(){
      fillSelect(els.d1, "monte_verde_mg");
      fillSelect(els.d2, "serra_negra_sp");
      fillSelect(els.d3, "gramado_canela_rs");
      fillSelect(els.d4, "pocos_de_caldas_mg");
      await loadPulseData();
      run();
    }

    els.btnRun.addEventListener("click", async () => { await loadPulseData(); run(); });
    els.btnCopy.addEventListener("click", () => {
      navigator.clipboard.writeText(els.bulletin.innerText.trim()).then(() => {
        els.btnCopy.textContent = "Copiado!";
        setTimeout(() => (els.btnCopy.textContent = "Copiar boletim"), 1200);
      });
    });

    if (checkAuth()) boot();

    (function matrix(){
      const canvas = document.getElementById("matrix");
      const ctx = canvas.getContext("2d");
      function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
      window.addEventListener("resize", resize);
      resize();
      const chars = "01ABRALLINONE";
      const fontSize = 16;
      let columns = Math.floor(canvas.width / fontSize);
      let drops = Array(columns).fill(1);
      function draw(){
        ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.font = fontSize + "px monospace";
        ctx.fillStyle = "rgba(0, 198, 255, 0.35)";
        for (let i = 0; i < drops.length; i++){
          const text = chars[Math.floor(Math.random() * chars.length)];
          ctx.fillText(text, i * fontSize, drops[i] * fontSize);
          if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
          drops[i]++;
        }
      }
      setInterval(draw, 100);
    })();

    document.onkeydown = function(e) {
      if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && (e.keyCode == 73 || e.keyCode == 74 || e.keyCode == 67)) || (e.ctrlKey && e.keyCode == 85)) return false;
    };
  </script>
</body>
</html>
